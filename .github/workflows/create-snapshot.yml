name: create-snapshot
on:
  pull_request:
  workflow_dispatch:

jobs:
  create-snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
    
      - name: Create the Database
        run: docker compose -f docker-compose.yml up -d postgres
        env:
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

      - name: Wait for the Database to be ready
        run: |
          until docker exec postgres pg_isready; do
            echo "Waiting for PostgreSQL to be ready..."
            sleep 5
          done

      - name: Run Liquibase snapshot
        uses: liquibase-github-actions/snapshot@v4.29.1
        with:
          url: "jdbc:postgresql://postgres:5432/${{ secrets.POSTGRES_DB }}"
          username: ${{ secrets.POSTGRES_USER }}
          password: ${{ secrets.POSTGRES_PASSWORD }}
          driver: "org.postgresql.Driver"
          outputFile: "snapshot.json"

      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v4.3.5
        with:
          name: Database Snapshot
          path: snapshot.json

      - name: Clean up
        run: docker-compose down