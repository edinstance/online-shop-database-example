name: Supabase Deploy
on:
  workflow_dispatch:
  pull_request:
# Temporarily added Pull request trigger to test the workflow

jobs:
  supabase-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run database
        run: docker compose up postgres -d
        env:
          POSTGRES_DB: test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password

      - name: Run liquibase
        run: docker compose up liquibase
        env:
          POSTGRES_DB: test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_URL: postgres

      - name: Check if liquibase ran successfully
        run: |
          exit_code=$(docker inspect liquibase --format='{{.State.ExitCode}}')
          if [ "$exit_code" -ne 0 ]; then
            echo "Liquibase failed with exit code $exit_code"
            exit 1
          else
            echo "Liquibase ran successfully with exit code $exit_code"
          fi
    
      - name: Update Supabase database using liquibase
        run: docker compose up liquibase
        env: 
          POSTGRES_DB: ${{ secrets.SUPABASE_DB }}
          POSTGRES_USER: ${{ secrets.SUPABASE_USER }}
          POSTGRES_PASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
          POSTGRES_URL: ${{ secrets.SUPABASE_URL }}

      - name: Stop containers
        run: docker compose down